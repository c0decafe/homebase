name: smoke

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["container"]
    types: ["completed"]
  push:
    branches: [ master ]
    paths:
      - .github/workflows/smoke.yml
      - goss/**

jobs:
  smoke:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull image
        run: docker pull ghcr.io/c0decafe/homebase:latest
      - name: Install goss/dgoss
        env:
          GOSS_VERSION: v0.4.4
        run: |
          curl -L https://github.com/goss-org/goss/releases/download/${GOSS_VERSION}/goss-linux-amd64 | sudo tee /usr/local/bin/goss >/dev/null
          curl -L https://github.com/goss-org/goss/releases/download/${GOSS_VERSION}/dgoss | sudo tee /usr/local/bin/dgoss >/dev/null
          sudo chmod +x /usr/local/bin/goss /usr/local/bin/dgoss
      - name: Launch smoke container
        run: |
          docker run -d --name homebase-smoke --entrypoint /bin/bash ghcr.io/c0decafe/homebase:latest -lc "sleep infinity"

      - name: Install goss inside container
        run: |
          docker exec homebase-smoke bash -lc "goss-pre --version >/dev/null"

      - name: Run pre-init goss suite
        run: |
          docker exec homebase-smoke goss-pre validate

      - name: Run init script
        run: |
          docker exec homebase-smoke sudo /usr/local/share/init.sh

      - name: Run post-init goss suite
        run: |
          docker exec homebase-smoke goss-post validate

      - name: Cleanup smoke container
        if: always()
        run: |
          docker rm -f homebase-smoke >/dev/null 2>&1 || true
