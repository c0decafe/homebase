name: smoke

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["container"]
    types: ["completed"]
  push:
    branches: [ master ]
    paths:
      - .github/workflows/smoke.yml
      - goss/**

jobs:
  smoke:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') || github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Pull image
        run: docker pull ghcr.io/c0decafe/homebase:latest
      - name: Launch smoke container
        run: |
          docker run -d \
            --name homebase-smoke \
            --user root \
            --entrypoint /bin/bash \
            ghcr.io/c0decafe/homebase:latest \
            -lc "sleep infinity"

      - name: Print image os-release
        run: |
          docker exec homebase-smoke cat /etc/os-release

      - name: Verify goss wrappers
        run: |
          docker exec homebase-smoke bash -lc "goss-pre --version >/dev/null"

      - name: Run pre-init goss suite
        run: |
          docker exec -u vscode homebase-smoke goss-pre validate

      - name: Run homebase setup
        run: |
          docker exec homebase-smoke /bin/homebase-setup

      - name: Start SSH service
        run: |
          docker exec -d homebase-smoke /bin/homebase-ssh-service
          docker exec homebase-smoke bash -lc '
            for i in $(seq 1 30); do
              if ss -lnpt | grep -q ":2222"; then
                exit 0
              fi
              sleep 1
            done
            echo "sshd failed to start" >&2
            exit 1
          '

      - name: Run post-init goss suite
        run: |
          docker exec homebase-smoke goss-post validate

      - name: Cleanup smoke container
        if: always()
        run: |
          docker rm -f homebase-smoke >/dev/null 2>&1 || true
