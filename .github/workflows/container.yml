name: container
on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable-small

      - name: Configure Nix (flakes only)
        run: |
          mkdir -p ~/.config/nix
          cat > ~/.config/nix/nix.conf <<'EOF'
          experimental-features = nix-command flakes
          EOF

      - name: Build (capture out path; no lockfile)
        run: echo IMAGE_PATH=$(nix build -L --no-write-lock-file .#homebase --print-out-paths) >> $GITHUB_ENV

      - name: Set OCI label env
        run: |
          echo CREATED=$(date -u +%Y-%m-%dT%H:%M:%SZ) >> $GITHUB_ENV
          echo REV=${{ github.sha }} >> $GITHUB_ENV

      - name: Push with skopeo (no docker load)
        run: |
          nix shell -L --inputs-from . nixpkgs#skopeo --command             skopeo copy --retry-times 3 --insecure-policy               --dest-creds "c0decafe:${{ secrets.GITHUB_TOKEN }}"               --annotation org.opencontainers.image.created="${CREATED}"               --annotation org.opencontainers.image.revision="${REV}"               "docker-archive:${IMAGE_PATH}"               "docker://ghcr.io/c0decafe/homebase:latest"

      - name: Clean up Nix store and workspace
        run: |
          nix store gc || true
          df -h || true
