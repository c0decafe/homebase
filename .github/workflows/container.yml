name: container
on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable-small

      - name: Configure Nix (flakes only)
        shell: bash
        run: |
          mkdir -p "$HOME/.config/nix"
          printf "experimental-features = nix-command flakes\n" > "$HOME/.config/nix/nix.conf"

      - name: Login to GHCR (skopeo-compatible)
        shell: bash
        run: |
          mkdir -p "$HOME/.docker"
          AUTH="$(printf "%s:%s" "c0decafe" "${{ secrets.GITHUB_TOKEN }}" | base64 -w0)"
          printf '{ "auths": { "ghcr.io": { "auth": "%s" } } }\n' "$AUTH" > "$HOME/.docker/config.json"

      - name: Build image (pure Nix)
        run: nix build -L --no-write-lock-file .#homebase

      - name: Push image (nix2container -> GHCR)
        run: nix run -L --no-write-lock-file .#push

      - name: Cleanup
        run: |
          nix store gc || true
          df -h || true
