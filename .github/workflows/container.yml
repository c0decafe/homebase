name: container

on:
  push:
    branches: [ master ]
    paths:
      - flake.nix
      - .github/workflows/container.yml
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write

jobs:
  eval-flake:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-25.05-small
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

      - name: Evaluate flake targets
        run: |
          set -euo pipefail
          for attr in homebase-sudo homebase; do
            echo "Evaluating $attr"
            nix eval --no-write-lock-file ".#${attr}.drvPath" >/dev/null
          done

  sudo-base:
    needs: eval-flake
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-25.05-small
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

      - name: Configure Cachix
        uses: cachix/cachix-action@v14
        with:
          name: c0decafe
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Build sudo base image stream
        run: nix build -L --no-write-lock-file .#homebase-sudo

      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Load and push sudo base image
        run: |
          set -euo pipefail
          docker load -i result
          docker tag homebase-sudo-local:latest ghcr.io/${{ github.repository_owner }}/homebase-sudo:latest
          docker push ghcr.io/${{ github.repository_owner }}/homebase-sudo:latest

  home-flake-tools:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        attr: [ "cli", "editors", "containers", "desktop", "files" ]
    name: home flake (${{ matrix.attr }})
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-25.05-small
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

      - name: Configure Cachix
        uses: cachix/cachix-action@v14
        with:
          name: c0decafe
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Build ./home#${{ matrix.attr }}
        run: nix build -L --no-write-lock-file "./home#${{ matrix.attr }}"

      - name: Push ./home#${{ matrix.attr }} to Cachix
        run: nix path-info "./home#${{ matrix.attr }}" | cachix push c0decafe

  build-test-push:
    needs:
      - sudo-base
      - home-flake-tools
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-25.05-small
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

      - name: Configure Cachix
        uses: cachix/cachix-action@v14
        with:
          name: c0decafe
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Flake checks
        run: nix flake check -L --no-write-lock-file

      - name: Build image tarball
        run: nix build -L --no-write-lock-file .#homebase


      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push image to GHCR
        run: nix run .#homebase.copyToRegistry --no-sandbox
