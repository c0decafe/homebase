name: container

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-25.05-small

      - name: Enable flakes
        run: |
          mkdir -p "$HOME/.config/nix"
          printf "experimental-features = nix-command flakes\n" > "$HOME/.config/nix/nix.conf"

      - name: Build homebase image (nix2container)
        run: nix build -L --no-write-lock-file .#homebase

      - name: Login to GHCR (Docker auth)
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ACTOR: ${{ github.actor }}
        run: |
          echo "$TOKEN" | docker login ghcr.io -u "$ACTOR" --password-stdin

      - name: Expose Docker auth to skopeo
        run: echo "REGISTRY_AUTH_FILE=$HOME/.docker/config.json" >> "$GITHUB_ENV"

      - name: Copy to Docker registry (GHCR) via nix2container
        run: |
          nix run .#homebase.copyToRegistry -- ghcr.io/c0decafe/homebase:latest

      - name: Disk usage (debug)
        if: always()
        run: df -h
