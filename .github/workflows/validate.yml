name: Validate Image

on:
  workflow_dispatch:

jobs:
  ssh-smoke-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Set up Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-25.05-small
      - name: Build image
        run: nix build .#homebase
      - name: Smoke test ssh-init
        run: |
          IMAGE_TAR=$(readlink -f result)
          docker load < "$IMAGE_TAR" >/tmp/image-id.txt
          IMAGE_ID=$(tail -n1 /tmp/image-id.txt | awk '{print $3}')
          docker run --rm --name homebase-test "$IMAGE_ID" /usr/local/share/ssh-init.sh
